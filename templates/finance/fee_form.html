{% extends 'base.html' %}

{% block title %}{{ title }} - SIMS{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">{{ title }}</h1>
        <p class="text-gray-600 mt-2">
            {% if payment_type == 'insurance' %}
            Record Mutuelle de Santé (Health Insurance) payment for a family
            {% else %}
            Record school fee payment for a student
            {% endif %}
        </p>
    </div>
    
    <!-- Toggle buttons -->
    <div class="flex gap-3 mb-6">
        <a href="{% url 'finance:fee_create' %}?type=school_fee" 
           class="px-6 py-2 rounded-lg transition duration-200 font-medium
           {% if payment_type != 'insurance' %}bg-emerald-600 text-white{% else %}bg-white border border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            School Fees
        </a>
        <a href="{% url 'finance:fee_create' %}?type=insurance" 
           class="px-6 py-2 rounded-lg transition duration-200 font-medium
           {% if payment_type == 'insurance' %}bg-teal-600 text-white{% else %}bg-white border border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}">
            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            Mutuelle de Santé
        </a>
    </div>
    
    <div class="bg-white p-8 rounded-lg shadow-md">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            {% if payment_type == 'insurance' %}
            <!-- MUTUELLE DE SANTÉ FORM -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Family Selection -->
                <div class="md:col-span-1">
                    <label for="{{ form.family.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Family *
                    </label>
                    {{ form.family }}
                    {% if form.family.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.family.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">Select the family to record Mutuelle payment for</p>
                </div>

                <!-- Insurance Year -->
                <div>
                    <label for="{{ form.insurance_year.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Insurance Year *
                    </label>
                    {{ form.insurance_year }}
                    {% if form.insurance_year.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.insurance_year.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Required Amount -->
                <div>
                    <label for="{{ form.required_amount.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Required Amount (FRW) *
                    </label>
                    {{ form.required_amount }}
                    {% if form.required_amount.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.required_amount.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Amount Paid -->
                <div>
                    <label for="{{ form.amount_paid.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Amount Paid (FRW) *
                    </label>
                    {{ form.amount_paid }}
                    {% if form.amount_paid.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.amount_paid.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Coverage Status -->
                <div>
                    <label for="{{ form.coverage_status.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Coverage Status *
                    </label>
                    {{ form.coverage_status }}
                    {% if form.coverage_status.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.coverage_status.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Family Insurance Summary (fetched from database) -->
            <div id="family-insurance-summary" class="hidden bg-teal-50 border border-teal-200 rounded-lg p-4">
                <h3 class="font-semibold text-teal-900 mb-3">Current Insurance Record for This Family</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3">
                    <!-- Total Family Contribution -->
                    <div class="bg-white rounded p-3 border-l-4 border-emerald-500">
                        <p class="text-xs text-gray-600 uppercase tracking-wide">Total Contribution</p>
                        <p id="db-total-contribution" class="text-lg font-bold text-emerald-600">0 FRW</p>
                        <p class="text-xs text-gray-500 mt-1">All years</p>
                    </div>
                    <!-- Required Amount -->
                    <div class="bg-white rounded p-3 border-l-4 border-teal-500">
                        <p class="text-xs text-gray-600 uppercase tracking-wide">Required Amount</p>
                        <p id="db-required-amount" class="text-lg font-bold text-teal-600">0 FRW</p>
                        <p class="text-xs text-gray-500 mt-1">Current year</p>
                    </div>
                    <!-- Amount Paid -->
                    <div class="bg-white rounded p-3 border-l-4 border-green-500">
                        <p class="text-xs text-gray-600 uppercase tracking-wide">Amount Paid</p>
                        <p id="db-amount-paid" class="text-lg font-bold text-green-600">0 FRW</p>
                        <p class="text-xs text-gray-500 mt-1">Current year</p>
                    </div>
                    <!-- Outstanding Balance -->
                    <div class="bg-white rounded p-3 border-l-4 border-red-500">
                        <p class="text-xs text-gray-600 uppercase tracking-wide">Outstanding</p>
                        <p id="db-balance" class="text-lg font-bold text-red-600">0 FRW</p>
                        <p class="text-xs text-gray-500 mt-1">Current year</p>
                    </div>
                </div>
                <p class="text-xs text-teal-700">
                    <strong>Coverage Status:</strong> <span id="db-coverage-status">Not Covered</span>
                </p>
            </div>

            <!-- Payment Dates -->
            <div>
                <label for="{{ form.payment_dates.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    Payment Dates
                </label>
                {{ form.payment_dates }}
                {% if form.payment_dates.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.payment_dates.errors.0 }}</p>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">Comma-separated dates, e.g., 2024-01-15, 2024-02-20</p>
            </div>

            <!-- Remarks -->
            <div>
                <label for="{{ form.remarks.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    Remarks
                </label>
                {{ form.remarks }}
                {% if form.remarks.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.remarks.errors.0 }}</p>
                {% endif %}
            </div>

            {% else %}
            <!-- SCHOOL FEES FORM -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Student Selection -->
                <div class="md:col-span-1">
                    <label for="{{ form.student.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Student *
                    </label>
                    {{ form.student }}
                    {% if form.student.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.student.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">Select the student to record school fees for</p>
                </div>

                <!-- Academic Year -->
                <div>
                    <label for="{{ form.academic_year.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Academic Year *
                    </label>
                    {{ form.academic_year }}
                    {% if form.academic_year.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.academic_year.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Term -->
                <div>
                    <label for="{{ form.term.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Term *
                    </label>
                    {{ form.term }}
                    {% if form.term.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.term.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- School Name -->
                <div>
                    <label for="{{ form.school_name.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        School Name
                    </label>
                    {{ form.school_name }}
                    {% if form.school_name.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.school_name.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Class Level -->
                <div>
                    <label for="{{ form.class_level.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Class Level
                    </label>
                    {{ form.class_level }}
                    {% if form.class_level.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.class_level.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Total Fees -->
                <div>
                    <label for="{{ form.total_fees.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Total Fees (FRW) *
                    </label>
                    {{ form.total_fees }}
                    {% if form.total_fees.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.total_fees.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Amount Paid -->
                <div>
                    <label for="{{ form.amount_paid.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Amount Paid (FRW) *
                    </label>
                    {{ form.amount_paid }}
                    {% if form.amount_paid.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.amount_paid.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Payment Status -->
                <div>
                    <label for="{{ form.payment_status.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                        Payment Status *
                    </label>
                    {{ form.payment_status }}
                    {% if form.payment_status.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.payment_status.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Dates -->
            <div>
                <label for="{{ form.payment_dates.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    Payment Dates
                </label>
                {{ form.payment_dates }}
                {% if form.payment_dates.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.payment_dates.errors.0 }}</p>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">Comma-separated dates, e.g., 2024-01-15, 2024-02-20</p>
            </div>

            <!-- Comments -->
            <div>
                <label for="{{ form.comments.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                    Comments
                </label>
                {{ form.comments }}
                {% if form.comments.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.comments.errors.0 }}</p>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Form Actions -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <a href="{% url 'finance:dashboard' %}" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200 font-medium">
                    Cancel
                </a>
                <button type="submit" class="px-6 py-2 {% if payment_type == 'insurance' %}bg-teal-600 hover:bg-teal-700{% else %}bg-emerald-600 hover:bg-emerald-700{% endif %} text-white rounded-lg transition duration-200 font-medium">
                    Save Payment
                </button>
            </div>
        </form>
    </div>
</div>

{% if payment_type != 'insurance' %}
<script>
    // Fetch student details and auto-populate school and class level
    document.addEventListener('DOMContentLoaded', function() {
        const studentSelect = document.getElementById('id_student');
        const schoolNameInput = document.getElementById('id_school_name');
        const classLevelInput = document.getElementById('id_class_level');
        
        if (!studentSelect) return;
        
        // Function to fetch and populate student data
        function fetchStudentDetails(studentId) {
            if (!studentId) {
                // Clear fields if no student selected
                if (schoolNameInput) schoolNameInput.value = '';
                if (classLevelInput) classLevelInput.value = '';
                return;
            }
            
            // Fetch from API endpoint
            fetch(`/finance/api/student/${studentId}/details/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch student details');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Populate school name
                        if (schoolNameInput && data.school_name) {
                            schoolNameInput.value = data.school_name;
                        }
                        
                        // Populate class level
                        if (classLevelInput && data.class_level) {
                            classLevelInput.value = data.class_level;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching student details:', error);
                });
        }
        
        // Listen for student selection change
        studentSelect.addEventListener('change', function() {
            fetchStudentDetails(this.value);
        });
        
        // If student is already selected (edit mode), fetch their details
        if (studentSelect.value) {
            fetchStudentDetails(studentSelect.value);
        }
    });
</script>
{% else %}
<script>
    // Fetch family insurance details and display existing amounts
    document.addEventListener('DOMContentLoaded', function() {
        const familySelect = document.getElementById('id_family');
        const summaryDiv = document.getElementById('family-insurance-summary');
        const requiredAmountInput = document.getElementById('id_required_amount');
        const amountPaidInput = document.getElementById('id_amount_paid');
        const coverageStatusSelect = document.getElementById('id_coverage_status');
        const insuranceYearInput = document.getElementById('id_insurance_year');
        
        if (!familySelect) return;
        
        // Function to fetch and display family insurance data
        function fetchFamilyInsuranceDetails(familyId) {
            if (!familyId) {
                // Hide summary if no family selected
                if (summaryDiv) summaryDiv.classList.add('hidden');
                return;
            }
            
            // Fetch from API endpoint
            fetch(`/finance/api/family/${familyId}/insurance/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch family insurance details');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show summary section
                        if (summaryDiv) summaryDiv.classList.remove('hidden');
                        
                        // Format currency with thousands separator
                        const formatCurrency = (value) => {
                            return Number(value).toLocaleString('en-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' FRW';
                        };
                        
                        // Update display elements
                        document.getElementById('db-total-contribution').textContent = formatCurrency(data.total_contribution);
                        document.getElementById('db-required-amount').textContent = formatCurrency(data.required_amount);
                        document.getElementById('db-amount-paid').textContent = formatCurrency(data.amount_paid);
                        document.getElementById('db-balance').textContent = formatCurrency(data.balance);
                        document.getElementById('db-coverage-status').textContent = data.coverage_status;
                        
                        // Pre-fill form fields with existing data
                        if (requiredAmountInput) {
                            requiredAmountInput.value = data.required_amount;
                        }
                        if (amountPaidInput) {
                            amountPaidInput.value = data.amount_paid;
                        }
                        if (insuranceYearInput) {
                            insuranceYearInput.value = data.insurance_year_id || '';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching family insurance details:', error);
                    if (summaryDiv) summaryDiv.classList.add('hidden');
                });
        }
        
        // Listen for family selection change
        familySelect.addEventListener('change', function() {
            fetchFamilyInsuranceDetails(this.value);
        });
        
        // If family is already selected (edit mode), fetch their insurance details
        if (familySelect.value) {
            fetchFamilyInsuranceDetails(familySelect.value);
        }
    });
</script>
{% endif %}
{% endblock %}


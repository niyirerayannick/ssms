{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Analysis Dashboard - SIMS{% endblock %}

{% block content %}
<div class="p-6 space-y-8 animate-[fadeIn_0.5s_ease-out]">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Analysis Dashboard</h1>
            <p class="text-slate-500 mt-1">Overview of student demographics and financial metrics</p>
        </div>
        <div class="text-sm text-slate-500 bg-white/50 px-3 py-1.5 rounded-lg border border-slate-200">
            Data as of {% now "F j, Y" %}
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
        <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
            <!-- Academic Year -->
            <div>
                <label for="year" class="block text-sm font-medium text-slate-700 mb-1">Academic Year</label>
                <select name="year" id="year" class="w-full rounded-lg border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Years</option>
                    {% for year in academic_years %}
                    <option value="{{ year.id }}" {% if selected_year == year.id %}selected{% endif %}>{{ year.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Term -->
            <div>
                <label for="term" class="block text-sm font-medium text-slate-700 mb-1">Term</label>
                <select name="term" id="term" class="w-full rounded-lg border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Terms</option>
                    {% for val, label in terms %}
                    <option value="{{ val }}" {% if selected_term == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- District -->
            <div>
                <label for="district" class="block text-sm font-medium text-slate-700 mb-1">District</label>
                <select name="district" id="district" class="w-full rounded-lg border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Districts</option>
                    {% for district in districts %}
                    <option value="{{ district.id }}" {% if selected_district == district.id %}selected{% endif %}>{{ district.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Partner -->
            <div>
                <label for="partner" class="block text-sm font-medium text-slate-700 mb-1">Partner</label>
                <select name="partner" id="partner" class="w-full rounded-lg border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Partners</option>
                    {% for partner in partners %}
                    <option value="{{ partner.id }}" {% if selected_partner == partner.id %}selected{% endif %}>{{ partner.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Level -->
            <div>
                <label for="level" class="block text-sm font-medium text-slate-700 mb-1">School Level</label>
                <select name="level" id="level" class="w-full rounded-lg border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Levels</option>
                    {% for val, label in school_levels %}
                    <option value="{{ val }}" {% if selected_level == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                    Filter
                </button>
                <a href="{% url 'reports:analysis' %}" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors text-center flex items-center justify-center">
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Total Students -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-blue-50 text-blue-600 rounded-xl">
                    <span class="material-symbols-rounded text-3xl">groups</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Total Students</p>
                    <p class="text-2xl font-bold text-slate-800">{{ total_students|compact_number }}</p>
                </div>
            </div>
        </div>

        <!-- Average Performance -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-purple-50 text-purple-600 rounded-xl">
                    <span class="material-symbols-rounded text-3xl">school</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Average Mark</p>
                    <p class="text-2xl font-bold text-slate-800">{{ avg_marks }}%</p>
                </div>
            </div>
        </div>

        <!-- Pass Rate -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-indigo-50 text-indigo-600 rounded-xl">
                    <span class="material-symbols-rounded text-3xl">trending_up</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Pass Rate</p>
                    <p class="text-2xl font-bold text-slate-800">{{ pass_rate }}%</p>
                </div>
            </div>
        </div>

        <!-- Expected Fees -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-emerald-50 text-emerald-600 rounded-xl">
                    <span class="material-symbols-rounded text-3xl">payments</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Expected Fees</p>
                    <p class="text-2xl font-bold text-slate-800">{{ total_fees_expected|compact_number }}</p>
                </div>
            </div>
        </div>

        <!-- Paid Fees -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-green-50 text-green-600 rounded-xl">
                    <span class="material-symbols-rounded text-3xl">check_circle</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Fees Paid</p>
                    <p class="text-2xl font-bold text-slate-800">{{ total_fees_paid|compact_number }}</p>
                </div>
            </div>
        </div>

        <!-- Outstanding Balance -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-amber-50 text-amber-600 rounded-xl">
                    <span class="material-symbols-rounded text-3xl">pending</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Outstanding Balance</p>
                    <p class="text-2xl font-bold text-slate-800">{{ total_balance|compact_number }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gender Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Student Gender Distribution</h3>
            <div class="h-64 flex justify-center">
                <canvas id="genderChart"></canvas>
            </div>
        </div>

        <!-- School Level Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Students by School Level</h3>
            <div class="h-64">
                <canvas id="levelChart"></canvas>
            </div>
        </div>

        <!-- Fee Payment Status -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Fee Payment Status</h3>
            <div class="h-64">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Financial Overview -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Financial Overview</h3>
            <div class="h-64">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <!-- Partner Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Partner Distribution</h3>
            <div class="h-64 flex justify-center">
                <canvas id="partnerChart"></canvas>
            </div>
        </div>

        <!-- School Materials Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">School Materials Distribution</h3>
            <div class="h-64">
                <canvas id="materialsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        family: "'Manrope', sans-serif"
                    }
                }
            }
        }
    };

    // Gender Chart
    new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
            labels: {{ gender_labels|safe }},
            datasets: [{
                data: {{ gender_counts|safe }},
                backgroundColor: ['#3b82f6', '#ec4899', '#94a3b8'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    // School Level Chart
    new Chart(document.getElementById('levelChart'), {
        type: 'bar',
        data: {
            labels: {{ level_labels|safe }},
            datasets: [{
                label: 'Number of Students',
                data: {{ level_counts|safe }},
                backgroundColor: '#10b981',
                borderRadius: 6
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Partner Chart
    new Chart(document.getElementById('partnerChart'), {
        type: 'doughnut',
        data: {
            labels: {{ partner_labels|safe }},
            datasets: [{
                data: {{ partner_counts|safe }},
                backgroundColor: ['#8b5cf6', '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    // Materials Chart
    new Chart(document.getElementById('materialsChart'), {
        type: 'bar',
        data: {
            labels: {{ materials_labels|safe }},
            datasets: [{
                label: 'Received Count',
                data: {{ materials_counts|safe }},
                backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b'],
                borderRadius: 6
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Payment Status Chart
    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                data: {{ status_counts|safe }},
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    // Financial Overview Chart
    new Chart(document.getElementById('financeChart'), {
        type: 'bar',
        data: {
            labels: ['Expected', 'Paid', 'Balance'],
            datasets: [{
                label: 'Amount (RWF)',
                data: [{{ total_fees_expected }}, {{ total_fees_paid }}, {{ total_balance }}],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
                borderRadius: 6
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
</script>
{% endblock %}

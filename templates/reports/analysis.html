{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Analysis Dashboard - SIMS{% endblock %}

{% block content %}
<div class="space-y-6 sm:space-y-8 animate-[fadeIn_0.5s_ease-out]">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-blue-50 border border-blue-200 rounded-2xl p-4 sm:p-8 shadow-sm">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-4xl font-bold text-slate-900 tracking-tight">Analysis Dashboard</h1>
                <p class="text-sm sm:text-base text-slate-600 mt-1 sm:mt-2">Overview of student demographics and financial metrics</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden sm:block text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Data as of</p>
                    <p class="text-sm font-bold text-slate-700">{% now "F j, Y" %}</p>
                </div>
                <a href="{% url 'reports:index' %}" class="inline-flex items-center px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-xl border border-slate-200 shadow-sm transition-all active:scale-95 text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back
                </a>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-2xl p-4 sm:p-6 border border-slate-100 shadow-sm">
        <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
            <!-- Academic Year -->
            <div>
                <label for="year" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Academic Year</label>
                <select name="year" id="year" class="w-full rounded-xl border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500 bg-slate-50">
                    <option value="">All Years</option>
                    {% for year in academic_years %}
                    <option value="{{ year.id }}" {% if selected_year == year.id %}selected{% endif %}>{{ year.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Term -->
            <div>
                <label for="term" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Term</label>
                <select name="term" id="term" class="w-full rounded-xl border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500 bg-slate-50">
                    <option value="">All Terms</option>
                    {% for val, label in terms %}
                    <option value="{{ val }}" {% if selected_term == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- District -->
            <div>
                <label for="district" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">District</label>
                <select name="district" id="district" class="w-full rounded-xl border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500 bg-slate-50">
                    <option value="">All Districts</option>
                    {% for district in districts %}
                    <option value="{{ district.id }}" {% if selected_district == district.id %}selected{% endif %}>{{ district.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Partner -->
            <div>
                <label for="partner" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Partner</label>
                <select name="partner" id="partner" class="w-full rounded-xl border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500 bg-slate-50">
                    <option value="">All Partners</option>
                    {% for partner in partners %}
                    <option value="{{ partner.id }}" {% if selected_partner == partner.id %}selected{% endif %}>{{ partner.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Level -->
            <div>
                <label for="level" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">School Level</label>
                <select name="level" id="level" class="w-full rounded-xl border-slate-200 text-sm focus:ring-blue-500 focus:border-blue-500 bg-slate-50">
                    <option value="">All Levels</option>
                    {% for val, label in school_levels %}
                    <option value="{{ val }}" {% if selected_level == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Actions -->
            <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-slate-900 text-white px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-600 transition-all active:scale-95 shadow-lg shadow-slate-200">
                    Apply
                </button>
                <a href="{% url 'reports:analysis' %}" class="px-4 py-2.5 rounded-xl text-sm font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all active:scale-95">
                    Reset
                </a>
            </div>
        </form>
    </div>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
        <!-- Best District -->
        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-4 border border-blue-500 shadow-lg group relative overflow-hidden">
            <div class="absolute top-0 right-0 p-3 opacity-10">
                <span class="material-symbols-rounded text-6xl text-white">trophy</span>
            </div>
            <p class="text-[10px] font-bold text-blue-100 uppercase tracking-wider relative z-10">Top Performing District</p>
            <div class="flex items-end justify-between mt-1 relative z-10">
                <div>
                    <p class="text-xl sm:text-2xl font-black text-white truncate max-w-[120px]">{{ best_district.student__family__district__name|default:"N/A" }}</p>
                    <p class="text-[10px] font-bold text-blue-200 uppercase tracking-tighter">{{ best_district.success_rate|floatformat:1 }}% Success Rate</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/20">
                    <span class="material-symbols-rounded text-xl text-white">location_on</span>
                </div>
            </div>
        </div>

        <!-- Graduating Soon (S6) -->
        <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-2xl p-4 border border-emerald-500 shadow-lg group relative overflow-hidden">
            <div class="absolute top-0 right-0 p-3 opacity-10">
                <span class="material-symbols-rounded text-6xl text-white">school</span>
            </div>
            <p class="text-[10px] font-bold text-emerald-100 uppercase tracking-wider relative z-10">Upcoming Graduates (S6)</p>
            <div class="flex items-end justify-between mt-1 relative z-10">
                <div>
                    <p class="text-xl sm:text-2xl font-black text-white">{{ graduates_count|compact_number }}</p>
                    <p class="text-[10px] font-bold text-emerald-200 uppercase tracking-tighter">Students in Final Year</p>
                </div>
                <div class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center border border-white/20">
                    <span class="material-symbols-rounded text-xl text-white"></span>
                </div>
            </div>
        </div>

        <!-- Average Performance -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Avg Mark</p>
            <div class="flex items-end justify-between mt-1">
                <p class="text-xl sm:text-2xl font-black text-purple-600">{{ avg_marks }}%</p>
                <div class="w-8 h-8 rounded-lg bg-purple-50 flex items-center justify-center group-hover:bg-purple-100 transition-colors">
                    <span class="material-symbols-rounded text-lg text-purple-600">assessment</span>
                </div>
            </div>
        </div>

        <!-- Pass Rate -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Pass Rate</p>
            <div class="flex items-end justify-between mt-1">
                <p class="text-xl sm:text-2xl font-black text-indigo-600">{{ pass_rate }}%</p>
                <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center group-hover:bg-indigo-100 transition-colors">
                    <span class="material-symbols-rounded text-lg text-indigo-600">trending_up</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Distribution Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
        <!-- Lower Primary -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-blue-50 rounded-lg group-hover:bg-blue-100 transition-colors">
                    <span class="material-symbols-rounded text-base text-blue-600">child_care</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Lower Primary</p>
            </div>
            <p class="text-xl sm:text-2xl font-black text-slate-900">{{ category_counts.lower_primary|compact_number }}</p>
            <p class="text-[10px] text-slate-400 font-medium uppercase tracking-tighter mt-1">P1, P2, P3 Levels</p>
        </div>

        <!-- Upper Primary -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-indigo-50 rounded-lg group-hover:bg-indigo-100 transition-colors">
                    <span class="material-symbols-rounded text-base text-indigo-600">face</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Upper Primary</p>
            </div>
            <p class="text-xl sm:text-2xl font-black text-slate-900">{{ category_counts.upper_primary|compact_number }}</p>
            <p class="text-[10px] text-slate-400 font-medium uppercase tracking-tighter mt-1">P4, P5, P6 Levels</p>
        </div>

        <!-- Ordinary Level -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-emerald-50 rounded-lg group-hover:bg-emerald-100 transition-colors">
                    <span class="material-symbols-rounded text-base text-emerald-600">school</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Ordinary Level</p>
            </div>
            <p class="text-xl sm:text-2xl font-black text-slate-900">{{ category_counts.ordinary_level|compact_number }}</p>
            <p class="text-[10px] text-slate-400 font-medium uppercase tracking-tighter mt-1">S1, S2, S3 Levels</p>
        </div>

        <!-- Advanced Level -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-amber-50 rounded-lg group-hover:bg-amber-100 transition-colors">
                    <span class="material-symbols-rounded text-base text-amber-600">military_tech</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Advanced Level</p>
            </div>
            <p class="text-xl sm:text-2xl font-black text-slate-900">{{ category_counts.advanced_level|compact_number }}</p>
            <p class="text-[10px] text-slate-400 font-medium uppercase tracking-tighter mt-1">S4, S5, S6 Levels</p>
        </div>
    </div>

    <!-- Financial Status Row -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
        <!-- Total Students (Move here to make space for best district) -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Students</p>
            <div class="flex items-end justify-between mt-1">
                <p class="text-xl sm:text-2xl font-black text-slate-900">{{ total_students|compact_number }}</p>
                <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                    <span class="material-symbols-rounded text-lg text-blue-600">groups</span>
                </div>
            </div>
        </div>

        <!-- Expected Fees -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Expected Fees</p>
            <div class="flex items-end justify-between mt-1">
                <p class="text-xl sm:text-2xl font-black text-slate-900">{{ total_fees_expected|compact_number }}</p>
                <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center group-hover:bg-emerald-100 transition-colors">
                    <span class="material-symbols-rounded text-lg text-emerald-600">payments</span>
                </div>
            </div>
        </div>

        <!-- Paid Fees -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Paid</p>
            <div class="flex items-end justify-between mt-1">
                <p class="text-xl sm:text-2xl font-black text-green-600">{{ total_fees_paid|compact_number }}</p>
                <div class="w-8 h-8 rounded-lg bg-green-50 flex items-center justify-center group-hover:bg-green-100 transition-colors">
                    <span class="material-symbols-rounded text-lg text-green-600">check_circle</span>
                </div>
            </div>
        </div>

        <!-- Outstanding Balance -->
        <div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm hover:shadow-md transition-all group">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Balance</p>
            <div class="flex items-end justify-between mt-1">
                <p class="text-xl sm:text-2xl font-black text-amber-600">{{ total_balance|compact_number }}</p>
                <div class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center group-hover:bg-amber-100 transition-colors">
                    <span class="material-symbols-rounded text-lg text-amber-600">pending</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
        <!-- Gender Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                <span class="w-2 h-6 bg-blue-500 rounded-full mr-3"></span>
                Gender Distribution
            </h3>
            <div class="h-64 sm:h-72">
                <canvas id="genderChart"></canvas>
            </div>
        </div>

        <!-- School Level Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                <span class="w-2 h-6 bg-emerald-500 rounded-full mr-3"></span>
                Students by School Level
            </h3>
            <div class="h-64 sm:h-72">
                <canvas id="levelChart"></canvas>
            </div>
        </div>

        <!-- Fee Payment Status -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                <span class="w-2 h-6 bg-indigo-500 rounded-full mr-3"></span>
                Fee Payment Status
            </h3>
            <div class="h-64 sm:h-72">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Financial Overview -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                <span class="w-2 h-6 bg-amber-500 rounded-full mr-3"></span>
                Financial Overview
            </h3>
            <div class="h-64 sm:h-72">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <!-- Partner Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                <span class="w-2 h-6 bg-purple-500 rounded-full mr-3"></span>
                Partner Distribution
            </h3>
            <div class="h-64 sm:h-72">
                <canvas id="partnerChart"></canvas>
            </div>
        </div>

        <!-- School Materials Distribution -->
        <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-md transition-all">
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center">
                <span class="w-2 h-6 bg-pink-500 rounded-full mr-3"></span>
                Materials Distribution
            </h3>
            <div class="h-64 sm:h-72">
                <canvas id="materialsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        family: "'Manrope', sans-serif",
                        size: 11,
                        weight: '600'
                    },
                    color: '#64748b'
                }
            },
            tooltip: {
                backgroundColor: '#1e293b',
                padding: 12,
                titleFont: { size: 14, weight: 'bold' },
                bodyFont: { size: 13 },
                cornerRadius: 8,
                displayColors: true
            }
        }
    };

    // Gender Chart
    new Chart(document.getElementById('genderChart'), {
        type: 'doughnut',
        data: {
            labels: {{ gender_labels|safe }},
            datasets: [{
                data: {{ gender_counts|safe }},
                backgroundColor: ['#3b82f6', '#ec4899', '#94a3b8'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    // School Level Chart
    new Chart(document.getElementById('levelChart'), {
        type: 'bar',
        data: {
            labels: {{ level_labels|safe }},
            datasets: [{
                label: 'Number of Students',
                data: {{ level_counts|safe }},
                backgroundColor: '#10b981',
                borderRadius: 6
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Partner Chart
    new Chart(document.getElementById('partnerChart'), {
        type: 'doughnut',
        data: {
            labels: {{ partner_labels|safe }},
            datasets: [{
                data: {{ partner_counts|safe }},
                backgroundColor: ['#8b5cf6', '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    // Materials Chart
    new Chart(document.getElementById('materialsChart'), {
        type: 'bar',
        data: {
            labels: {{ materials_labels|safe }},
            datasets: [{
                label: 'Received Count',
                data: {{ materials_counts|safe }},
                backgroundColor: ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b'],
                borderRadius: 6
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Payment Status Chart
    new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                data: {{ status_counts|safe }},
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6366f1'],
                borderWidth: 0
            }]
        },
        options: commonOptions
    });

    // Financial Overview Chart
    new Chart(document.getElementById('financeChart'), {
        type: 'bar',
        data: {
            labels: ['Expected', 'Paid', 'Balance'],
            datasets: [{
                label: 'Amount (RWF)',
                data: [{{ total_fees_expected }}, {{ total_fees_paid }}, {{ total_balance }}],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
                borderRadius: 6
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
</script>
{% endblock %}

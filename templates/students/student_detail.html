{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ student.full_name }} - SIMS{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-b from-emerald-900 via-teal-900 to-emerald-800 rounded-xl shadow-lg p-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                {% if student.profile_picture %}
                    <img src="{{ student.profile_picture.url }}" 
                         alt="{{ student.full_name }}" 
                         class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover gallery-image"
                         data-title="{{ student.full_name }}"
                         data-subtitle="Profile Picture"
                         data-caption="Student Profile Picture">
                {% else %}
                    <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg bg-white bg-opacity-20 flex items-center justify-center">
                        <span class="text-3xl font-bold">{{ student.full_name|first|upper }}</span>
                    </div>
                {% endif %}
                <div>
                    <h1 class="text-3xl font-bold">{{ student.full_name }}</h1>
                    <p class="text-emerald-100">{{ student.get_gender_display }} • Age {{ student.age }}</p>
                </div>
            </div>
            {% if perms.students.change_student %}
            <div class="flex flex-wrap items-center gap-3">
                {% if student.sponsorship_status == 'pending' and can_approve_student %}
                <form method="post" action="{% url 'students:student_approve' student.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md">
                        Approve Student
                    </button>
                </form>
                {% endif %}
                <a href="{% url 'students:student_edit' student.pk %}" class="bg-white text-emerald-700 px-6 py-2 rounded-lg font-semibold hover:bg-emerald-50 transition duration-200 shadow-md">
                    Edit Student
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        {% if perms.finance.manage_fees %}
        <a href="{% url 'finance:student_payments' student.pk %}" class="bg-white hover:shadow-lg transition duration-200 p-4 rounded-lg shadow-md flex items-center space-x-3 border-l-4 border-blue-500">
            <svg class="w-8 h-8 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
                <p class="font-semibold text-gray-900">Payment History</p>
                <p class="text-xs text-gray-500">View all school fees</p>
            </div>
        </a>
        
        <a href="{% url 'finance:add_student_payment' student.pk %}" class="bg-white hover:shadow-lg transition duration-200 p-4 rounded-lg shadow-md flex items-center space-x-3 border-l-4 border-green-500">
            <svg class="w-8 h-8 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            <div>
                <p class="font-semibold text-gray-900">Record Payment</p>
                <p class="text-xs text-gray-500">Add school fee payment</p>
            </div>
        </a>
        {% endif %}
        <a href="{% url 'students:student_photos' student.pk %}" class="bg-white hover:shadow-lg transition duration-200 p-4 rounded-lg shadow-md flex items-center space-x-3 border-l-4 border-purple-500">
            <svg class="w-8 h-8 text-purple-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <div>
                <p class="font-semibold text-gray-900">Photo Gallery</p>
                <p class="text-xs text-gray-500">View student photos</p>
            </div>
        </a>
        <a href="{% url 'students:student_report_cards' student.pk %}" class="bg-white hover:shadow-lg transition duration-200 p-4 rounded-lg shadow-md flex items-center space-x-3 border-l-4 border-green-500">
            <svg class="w-8 h-8 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <div>
                <p class="font-semibold text-gray-900">Academic Records</p>
                <p class="text-xs text-gray-500">View marks history</p>
            </div>
        </a>
    </div>
    
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Personal Information -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Personal Information
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Full Name</p>
                        <p class="font-medium text-gray-900">{{ student.full_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Gender</p>
                        <p class="font-medium text-gray-900">{{ student.get_gender_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date of Birth</p>
                        <p class="font-medium text-gray-900">{{ student.date_of_birth|date:"M d, Y" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Age</p>
                        <p class="font-medium text-gray-900">{{ student.age }} years old</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Class Level</p>
                        <p class="font-medium text-gray-900">{{ student.class_level }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">School Level</p>
                        <p class="font-medium text-gray-900">{{ student.get_school_level_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Boarding Status</p>
                        <p class="font-medium text-gray-900">{{ student.get_boarding_status_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">School</p>
                        <p class="font-medium text-gray-900">
                            {% if student.school %}
                                <a href="{% url 'core:school_detail' student.school.pk %}" class="text-blue-600 hover:underline">{{ student.school.name }}</a>
                            {% else %}
                                <span class="text-gray-400">N/A</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Enrollment Status</p>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                            {% if student.enrollment_status == 'enrolled' %}bg-green-100 text-green-800
                            {% elif student.enrollment_status == 'transferred' %}bg-blue-100 text-blue-800
                            {% elif student.enrollment_status == 'graduated' %}bg-purple-100 text-purple-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ student.get_enrollment_status_display }}
                        </span>
                    </div>
                    {% if student.sponsorship_reason %}
                    <div class="col-span-2">
                        <p class="text-sm text-gray-600">Reason for Support</p>
                        <p class="font-medium text-gray-900 whitespace-pre-wrap">{{ student.sponsorship_reason }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-sm text-gray-600">Account Status</p>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                            {% if student.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {% if student.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    <div class="col-span-2">
                        <p class="text-sm text-gray-600">Location</p>
                        <p class="font-medium text-gray-900">{{ student.location_display|default:"Not specified" }}</p>
                    </div>
                </div>
            </div>

            <!-- Disability & Special Needs Card -->
            {% if student.has_disability %}
            <div class="bg-gradient-to-br from-red-50 to-orange-50 border-2 border-red-200 rounded-xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Disability & Special Needs Information
                </h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm text-gray-600 font-medium mb-1">Disability Status</p>
                        <p class="text-lg font-semibold text-red-700">✓ Student has reported disability</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium mb-1">Types of Disabilities</p>
                        <p class="text-base font-medium text-gray-800">{{ student.disability_display }}</p>
                    </div>
                    {% if student.disability_description %}
                    <div class="p-4 bg-white rounded-lg border-l-4 border-red-500">
                        <p class="text-sm text-gray-600 font-medium mb-2">Special Needs & Accommodations</p>
                        <p class="text-gray-800 whitespace-pre-wrap">{{ student.disability_description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Disability Status</h3>
                <p class="text-gray-700"><svg class="w-5 h-5 inline mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>No disability reported</p>
            </div>
            {% endif %}
            
            <!-- Photo Gallery -->
            <div id="photo-gallery" class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Photo Gallery
                    </h2>
                    <a href="{% url 'students:add_photo' student.pk %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">+ Add Photo</a>
                </div>
                {% if student.photos.all %}
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {% for photo in student.photos.all %}
                    <div class="relative group block">
                        <img src="{{ photo.image.url }}" 
                             alt="{{ photo.caption|default:student.full_name }}" 
                             class="w-full h-32 object-cover rounded-lg shadow-md hover:shadow-xl transition duration-200 gallery-image"
                             data-title="{{ student.full_name }}"
                             data-subtitle="{{ photo.created_at|date:'M d, Y' }}"
                             data-caption="{{ photo.caption|default:'' }}">
                        {% if photo.caption %}
                        <p class="text-xs text-gray-600 mt-1">{{ photo.caption }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">No photos uploaded yet.</p>
                {% endif %}
            </div>
            
            <!-- Academic Records -->
            <div id="academic-records" class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        Academic Records
                    </h2>
                    <a href="{% url 'students:add_academic_record' student.pk %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">+ Add Record</a>
                </div>
                {% if student.academic_records.all %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marks</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Term</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Year</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for record in student.academic_records.all %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium text-gray-900">{{ record.subject }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ record.marks }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ record.term }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ record.academic_year.name|default:"N/A" }}</td>
                                <td class="px-4 py-3 text-sm">
                                    {% if record.report_card_image %}
                                    <button class="text-blue-600 hover:text-blue-800 gallery-image"
                                            data-title="{{ student.full_name }} - Report Card"
                                            data-subtitle="{{ record.subject }} • {{ record.term }}"
                                            data-caption="Year {{ record.academic_year.name|default:'N/A' }} • Marks {{ record.marks }}"
                                            data-src="{{ record.report_card_image.url }}">
                                        View Report
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">No academic records yet.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Family Information -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.856-1.487M9 20H4v-2a3 3 0 015.856-1.487M15 6a3 3 0 11-6 0 3 3 0 016 0zm6 0a2 2 0 11-4 0 2 2 0 014 0zM5 20a2 2 0 01-2-2v-2a2 2 0 012-2h10a2 2 0 012 2v2a2 2 0 01-2 2H5z"/>
                    </svg>
                    Family Information
                </h3>
                {% if family %}
                <div class="space-y-3">
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600 font-medium">Family</p>
                        <p class="text-lg font-semibold text-gray-900">
                            <a href="{% url 'families:family_detail' family.pk %}" class="text-blue-600 hover:underline">
                                {{ family.family_code }}
                            </a>
                        </p>
                        <p class="text-sm text-gray-700 mt-1">Head: {{ family.head_of_family }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Phone</p>
                        <p class="font-medium text-gray-900">
                            <a href="tel:{{ family.phone_number }}" class="text-blue-600 hover:underline">{{ family.phone_number }}</a>
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Family Members</p>
                        <p class="font-medium text-gray-900">{{ family.total_family_members }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Father Name</p>
                        <p class="font-medium text-gray-900">
                            {% if family.father_name %}
                                {{ family.father_name }}
                            {% else %}
                                <span class="text-gray-400">Not provided</span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Mother Name</p>
                        <p class="font-medium text-gray-900">
                            {% if family.mother_name %}
                                {{ family.mother_name }}
                            {% else %}
                                <span class="text-gray-400">Not provided</span>
                            {% endif %}
                        </p>
                    </div>
                    {% if family.is_orphan %}
                    <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                        <p class="text-sm text-gray-600 font-medium">Guardian</p>
                        <p class="font-medium text-gray-900">
                            {{ family.guardian_name|default:"Not provided" }}
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            {% if family.guardian_phone %}
                                <a href="tel:{{ family.guardian_phone }}" class="text-emerald-600 hover:underline">{{ family.guardian_phone }}</a>
                            {% else %}
                                <span class="text-gray-400">No phone</span>
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Family Contribution</p>
                        <p class="text-lg font-bold text-green-600">{{ family.total_contribution|compact_number }} RWF</p>
                    </div>
                </div>
                {% else %}
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800">No family linked to this student</p>
                    <a href="{% url 'families:family_create' %}" class="text-blue-600 hover:underline text-sm font-medium mt-2 inline-block">Create Family →</a>
                </div>
                {% endif %}
            </div>
            
            <!-- System Timestamps -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    System Information
                </h3>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="text-gray-600 font-medium">Added on</p>
                        <p class="text-gray-900">{{ student.created_at|date:"M d, Y \a\t H:i" }}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 font-medium">Last Updated</p>
                        <p class="text-gray-900">{{ student.updated_at|date:"M d, Y \a\t H:i" }}</p>
                    </div>
                </div>
            </div>
            
                       
            <!-- Fees Summary -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">School Fee Information</h3>
                {% if student.school %}
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">School</p>
                        <p class="text-lg font-semibold text-gray-900">
                            <a href="{% url 'core:school_detail' student.school.pk %}" class="text-blue-600 hover:underline">
                                {{ student.school.name }}
                            </a>
                        </p>
                    </div>
                    <div class="border-t pt-3">
                        <p class="text-sm text-gray-600 font-medium">Standard Fee</p>
                        <p class="text-2xl font-bold text-green-600">{{ student.school.fee_amount|compact_number }} RWF</p>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No school assigned yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
    
    {% include 'partials/lightbox.html' %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.initLightbox) {
            window.initLightbox();
        }
    });
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}{{ title }} - SIMS{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-0">
    <div class="flex items-center gap-3 mb-6">
        <a href="{% url 'insurance:insurance_list' %}" class="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
        </a>
        <h1 class="text-2xl md:text-3xl font-bold text-slate-900">{{ title }}</h1>
    </div>
    
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/60">
        <form method="post" class="space-y-8">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="md:col-span-2 lg:col-span-1">
                    <label for="{{ form.family.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Family *
                    </label>
                    {{ form.family }}
                    {% if form.family.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.family.errors.0 }}</p>
                    {% endif %}
                    <p class="text-[10px] text-slate-500 mt-1.5 font-medium">Select the family to record Mutuelle payment for</p>
                </div>
                
                <div>
                    <label for="{{ form.insurance_year.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Insurance Year *
                    </label>
                    {{ form.insurance_year }}
                    {% if form.insurance_year.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.insurance_year.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.required_amount.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Required Amount (FRW) *
                    </label>
                    {{ form.required_amount }}
                    {% if form.required_amount.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.required_amount.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.amount_paid.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Amount Paid (FRW) *
                    </label>
                    {{ form.amount_paid }}
                    {% if form.amount_paid.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.amount_paid.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.coverage_status.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Coverage Status *
                    </label>
                    {{ form.coverage_status }}
                    {% if form.coverage_status.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.coverage_status.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <div id="family-insurance-summary" class="hidden bg-slate-50 border border-slate-200/60 rounded-2xl p-5 space-y-4">
                <div class="flex items-center gap-2 text-slate-900">
                    <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-bold text-sm uppercase tracking-wider">Current Insurance Summary</h3>
                </div>
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white rounded-xl p-4 border border-slate-200/50 shadow-sm">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Total Contribution</p>
                        <p id="db-total-contribution" class="text-lg font-bold text-slate-900 mt-1">0 FRW</p>
                        <p class="text-[10px] text-slate-400 mt-1 font-medium italic">All years</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-200/50 shadow-sm">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Required</p>
                        <p id="db-required-amount" class="text-lg font-bold text-indigo-600 mt-1">0 FRW</p>
                        <p class="text-[10px] text-slate-400 mt-1 font-medium italic">Current year</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-200/50 shadow-sm">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Paid</p>
                        <p id="db-amount-paid" class="text-lg font-bold text-emerald-600 mt-1">0 FRW</p>
                        <p class="text-[10px] text-slate-400 mt-1 font-medium italic">Current year</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 border border-slate-200/50 shadow-sm">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Outstanding</p>
                        <p id="db-balance" class="text-lg font-bold text-rose-600 mt-1">0 FRW</p>
                        <p class="text-[10px] text-slate-400 mt-1 font-medium italic">Current year</p>
                    </div>
                </div>
                
                <div class="pt-2 border-t border-slate-200/60 flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Coverage Status</span>
                    <span id="db-coverage-status" class="px-2.5 py-1 bg-slate-200 text-slate-700 rounded-full text-[10px] font-bold uppercase tracking-wider">Not Covered</span>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label for="{{ form.payment_dates.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Payment Dates
                    </label>
                    {{ form.payment_dates }}
                    {% if form.payment_dates.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.payment_dates.errors.0 }}</p>
                    {% endif %}
                    <p class="text-[10px] text-slate-500 mt-1.5 font-medium">Comma-separated dates, e.g., 2024-01-15, 2024-02-20</p>
                </div>
                
                <div>
                    <label for="{{ form.remarks.id_for_label }}" class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">
                        Remarks
                    </label>
                    {{ form.remarks }}
                    {% if form.remarks.errors %}
                        <p class="text-rose-500 text-xs mt-1">{{ form.remarks.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 pt-4">
                <a href="{% url 'insurance:insurance_list' %}" 
                   class="w-full sm:w-auto text-center px-6 py-2.5 border border-slate-200 rounded-xl text-slate-600 font-bold text-sm hover:bg-slate-50 transition-all active:scale-95">
                    Cancel
                </a>
                <button type="submit" 
                        class="w-full sm:w-auto px-8 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm shadow-sm shadow-indigo-200 transition-all active:scale-95">
                    Save Payment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const familySelect = document.getElementById('id_family');
        const summaryDiv = document.getElementById('family-insurance-summary');
        const requiredAmountInput = document.getElementById('id_required_amount');
        const amountPaidInput = document.getElementById('id_amount_paid');
        const insuranceYearInput = document.getElementById('id_insurance_year');
        const dbStatusBadge = document.getElementById('db-coverage-status');
        
        if (!familySelect) return;
        
        function updateBadgeStyle(status) {
            if (!dbStatusBadge) return;
            dbStatusBadge.textContent = status;
            
            // Remove existing status classes
            dbStatusBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider transition-colors';
            
            const lowerStatus = status.toLowerCase();
            if (lowerStatus.includes('fully')) {
                dbStatusBadge.classList.add('bg-emerald-100', 'text-emerald-700');
            } else if (lowerStatus.includes('partial')) {
                dbStatusBadge.classList.add('bg-amber-100', 'text-amber-700');
            } else {
                dbStatusBadge.classList.add('bg-slate-100', 'text-slate-600');
            }
        }
        
        function fetchFamilyInsuranceDetails(familyId) {
            if (!familyId) {
                if (summaryDiv) summaryDiv.classList.add('hidden');
                return;
            }
            
            fetch(`/finance/api/family/${familyId}/insurance/`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to fetch family insurance details');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (summaryDiv) summaryDiv.classList.remove('hidden');
                        
                        const formatCurrency = (value) => {
                            let num = Number(value);
                            if (isNaN(num)) return '0 FRW';
                            let suffix = '';
                            if (num >= 1000000000) {
                                num = num / 1000000000;
                                suffix = 'B';
                            } else if (num >= 1000000) {
                                num = num / 1000000;
                                suffix = 'M';
                            } else if (num >= 1000) {
                                num = num / 1000;
                                suffix = 'k';
                            }
                            let formatted = num.toFixed(1).replace(/\.0$/, '');
                            return formatted + suffix + ' FRW';
                        };
                        
                        document.getElementById('db-total-contribution').textContent = formatCurrency(data.total_contribution);
                        document.getElementById('db-required-amount').textContent = formatCurrency(data.required_amount);
                        document.getElementById('db-amount-paid').textContent = formatCurrency(data.amount_paid);
                        document.getElementById('db-balance').textContent = formatCurrency(data.balance);
                        
                        updateBadgeStyle(data.coverage_status);
                        
                        if (requiredAmountInput) {
                            requiredAmountInput.value = data.required_amount;
                            if (typeof requiredAmountInput.updateCompactDisplay === 'function') {
                                requiredAmountInput.updateCompactDisplay();
                            }
                        }
                        if (amountPaidInput) {
                            amountPaidInput.value = data.amount_paid;
                            if (typeof amountPaidInput.updateCompactDisplay === 'function') {
                                amountPaidInput.updateCompactDisplay();
                            }
                        }
                        if (insuranceYearInput) {
                            insuranceYearInput.value = data.insurance_year_id || '';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (summaryDiv) summaryDiv.classList.add('hidden');
                });
        }
        
        familySelect.addEventListener('change', function() {
            fetchFamilyInsuranceDetails(this.value);
        });
        
        const attachCompactDisplay = (input) => {
            if (!input) return;

            const display = document.createElement('div');
            display.className = 'text-[10px] text-slate-500 mt-1.5 font-bold uppercase tracking-wider';
            input.parentNode.insertBefore(display, input.nextSibling);

            const updateDisplay = () => {
                const val = input.value;
                if (val && !isNaN(val)) {
                    // Try to use a global formatCompact if available, else simple format
                    const formatted = (typeof formatCompact === 'function') ? formatCompact(val) : val;
                    display.textContent = `â‰ˆ ${formatted} FRW`;
                } else {
                    display.textContent = '';
                }
            };

            input.addEventListener('input', updateDisplay);
            updateDisplay(); 
            input.updateCompactDisplay = updateDisplay;
        };

        attachCompactDisplay(requiredAmountInput);
        attachCompactDisplay(amountPaidInput);
        
        if (familySelect.value) {
            fetchFamilyInsuranceDetails(familySelect.value);
        }
    });
</script>
{% endblock %}

